name: Data Package Checks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual override option

jobs:
  data-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup R (for timestamp check)
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'
        
    - name: Check rate limit
      id: rate-limit-check
      run: |
        # Check if timestamp file exists and if enough time has passed
        if [ -f ".last-data-check" ]; then
          last_check=$(cat .last-data-check)
          echo "Last check was: $last_check"
          
          # Calculate time difference in hours
          current_time=$(date -u +%s)
          last_time=$(date -d "$last_check" +%s 2>/dev/null || echo "0")
          time_diff=$(( (current_time - last_time) / 3600 ))
          
          echo "Hours since last check: $time_diff"
          
          if [ $time_diff -lt 6 ]; then
            echo "⏸️  Skipping - last check was only $time_diff hours ago (minimum: 6 hours)"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Proceeding - last check was $time_diff hours ago"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "✅ No previous timestamp found - proceeding with first run"
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Setup R dependencies
      if: steps.rate-limit-check.outputs.should_run == 'true'
      env:
        _R_CHECK_FORCE_SUGGESTS_: false  # Disable automatic Quarto installation
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        packages: |
          any::here
          any::tidyverse
          any::rlog
          any::devtools
          any::hms
          any::fs
          any::clipr
          any::knitr
          any::kableExtra
          any::DT
          any::rmarkdown
          any::plotly
          any::downloadthis
          any::cli
          any::rstudioapi
        cache-version: 2
        needs: check
        
    - name: Install system dependencies
      if: steps.rate-limit-check.outputs.should_run == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev pandoc
      
    - name: Verify Pandoc installation
      if: steps.rate-limit-check.outputs.should_run == 'true'
      run: pandoc --version
      
    - name: Run data package checks
      if: steps.rate-limit-check.outputs.should_run == 'true'
      run: |
        # Load required libraries
        library(here)
        library(tidyverse)
        library(rlog)
        library(devtools)
        library(hms)
        library(fs)
        library(clipr)
        library(knitr)
        library(kableExtra)
        library(DT)
        library(rmarkdown)
        library(plotly)
        library(downloadthis)
        library(cli)
        
        # Set working directory to repo root
        setwd(here())
        
        # User inputs (automated for GitHub Actions)
        user_directory <- here()
        report_author <- "${{ github.actor }}"
        report_out_dir <- file.path(here(), "data_checks_reports")
        user_input_has_header_rows <- FALSE
        has_flmd <- FALSE
        flmd_path <- ""
        user_exclude_files <- NA_character_
        user_include_files <- NA_character_
        user_include_dot_files <- TRUE
        
        # Source required functions from GitHub
        source_url("https://raw.githubusercontent.com/river-corridors-sfa/rcsfa-data_processing_for_publication/main/Data_Package_Documentation/functions/create_flmd.R")
        source_url("https://raw.githubusercontent.com/river-corridors-sfa/rcsfa-data_processing_for_publication/main/Data_Transformation/functions/load_tabular_data.R")
        source_url("https://raw.githubusercontent.com/river-corridors-sfa/rcsfa-data_processing_for_publication/main/Data_Package_Validation/functions/checks.R")
        
        # Check if directory has files
        if (length(list.files(user_directory, recursive = TRUE)) == 0) {
          warning("Your directory has 0 files.")
        }
        
        # 1. Get all files
        dp_files <- get_files(directory = user_directory,
                              exclude_files = user_exclude_files,
                              include_files = user_include_files,
                              include_dot_files = user_include_dot_files)
        
        # 2. Set flmd to NA (no existing flmd)
        data_package_flmd <- NA
        
        # 3. Load data
        data_package_data <- load_tabular_data(files_df = dp_files, 
                                               flmd_df = data_package_flmd, 
                                               query_header_info = user_input_has_header_rows)
        
        # Preview data
        invisible(lapply(names(data_package_data$tabular_data), function(name) {
          cat("\n--- Data Preview of", name, "---\n")
          print(glimpse(data_package_data$tabular_data[[name]]))
        }))
        
        # 4. Run checks (input_parameters defined in checks.R)
        data_package_checks <- check_data_package(data_package_data = data_package_data, 
                                                   input_parameters = input_parameters)
        
        # 5. Generate report
        out_file <- paste0("Checks_Report_", Sys.Date(), ".html")
        
        # Render report using the checks_report.Rmd in data_checks_reports folder
        rmarkdown::render("data_checks_reports/checks_report.Rmd", 
                         output_format = "html_document", 
                         output_dir = report_out_dir, 
                         output_file = out_file,
                         envir = new.env())
        
        # Print success message
        cat("Report generated successfully:", file.path(report_out_dir, out_file), "\n")
        
      shell: Rscript {0}
      
    - name: Update timestamp
      if: steps.rate-limit-check.outputs.should_run == 'true'
      run: |
        # Write current timestamp to file
        date -u +"%Y-%m-%dT%H:%M:%SZ" > .last-data-check
        echo "Updated timestamp: $(cat .last-data-check)"
        
    - name: Commit and push report
      if: steps.rate-limit-check.outputs.should_run == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data_checks_reports/ .last-data-check
        git diff --staged --quiet || git commit -m "Auto-update data package checks report [skip ci]"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload report as artifact
      if: steps.rate-limit-check.outputs.should_run == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: data-checks-report
        path: data_checks_reports/